AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Smart Accountant Infrastructure
Globals:
  Function:
    Timeout: 10
    Runtime: python3.12
Resources:
  InvoiceBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: smart-accountant-upload-${AWS::AccountId}
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - POST
          - HEAD
          AllowedOrigins:
          - '*'
          MaxAge: 3000
  InvoiceTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: SmartAccountantData
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: UserId
        AttributeType: S
      - AttributeName: InvoiceId
        AttributeType: S
      KeySchema:
      - AttributeName: UserId
        KeyType: HASH
      - AttributeName: InvoiceId
        KeyType: RANGE
  SmartAccountantApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowMethods:
        - GET
        - POST
        - OPTIONS
        AllowHeaders:
        - '*'
        AllowOrigins:
        - '*'
  UploadTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UploadTriggerFunction
      Handler: app.lambda_handler
      Environment:
        Variables:
          UPLOAD_BUCKET_NAME:
            Ref: InvoiceBucket
      Policies:
      - Statement:
        - Effect: Allow
          Action: s3:PutObject
          Resource:
            Fn::Sub: arn:aws:s3:::smart-accountant-upload-${AWS::AccountId}/*
      Events:
        GetUploadUrl:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: SmartAccountantApi
            Path: /get-upload-url
            Method: GET
    Metadata:
      SamResourceId: UploadTriggerFunction
  ProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ProcessorFunction
      Handler: app.lambda_handler
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: smart-accountant-upload-${AWS::AccountId}
      - Statement:
        - Effect: Allow
          Action: textract:AnalyzeDocument
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          Resource:
            Fn::GetAtt:
            - InvoiceTable
            - Arn
      Events:
        FileUpload:
          Type: S3
          Properties:
            Bucket:
              Ref: InvoiceBucket
            Events: s3:ObjectCreated:*
    Metadata:
      SamResourceId: ProcessorFunction
  GetInvoiceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetInvoiceFunction
      Handler: app.lambda_handler
      Environment:
        Variables:
          TABLE_NAME:
            Ref: InvoiceTable
      Policies:
      - Statement:
        - Effect: Allow
          Action: dynamodb:GetItem
          Resource:
            Fn::GetAtt:
            - InvoiceTable
            - Arn
      Events:
        GetInvoice:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: SmartAccountantApi
            Path: /invoice/{invoice_id}
            Method: GET
    Metadata:
      SamResourceId: GetInvoiceFunction
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${SmartAccountantApi}.execute-api.${AWS::Region}.amazonaws.com
  BucketName:
    Value:
      Ref: InvoiceBucket
